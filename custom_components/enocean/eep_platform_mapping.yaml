# EnOcean EEP Platform Mapping
#
# This file maps EnOcean Equipment Profiles (EEP) to Home Assistant entities.
#
# value_template: Optional Jinja2 template to transform raw field values
#   Available variables:
#     - value: The raw field value extracted from the packet
#     - value_parsed: Full parsed packet data (dict with all fields)
#   Examples:
#     - "{{ value | round(1) }}"  # Round to 1 decimal
#     - "{{ value / 10 }}"  # Scale value
#     - \"{{ (value / 7 * 100) | round }}\"  # Battery percentage (0-7V to 0-100%)
#     - \"{{ value_parsed.TEMP if value_parsed.TEMP > 0 else 0 }}\"  # Conditional
#
# Note: MQTT-specific fields (state_topic, command_topic, payload_*, command_template)
#       are from the HA_enoceanmqtt project and shown for reference but are NOT used
#       by the native EnOcean integration. Only 'value_template' and standard HA entity
#       config (device_class, unit, icon, etc.) are processed.
#
0xD2:
  0x01:
    0x00:
      device_config:
        command: "CMD"
        channel: "CMD"
        log_learn: ""
        direction: ""
        answer: ""
      entities:
        - component: "number"
          name: "setpoint"
          config:
            min_value: 0
            max_value: 100
            unit: "%"
    0x01:
      device_config:
        command: "CMD"
        channel: "CMD"
        log_learn: ""
        direction: ""
        answer: ""
      entities:
        - component: "switch"
          name: "switch"
          config:
            state_topic: "CMD4"
            state_on: "100"
            state_off: "0"
            value_template: "{{ value_parsed.OV }}"
            command_topic: "req"
            payload_on: >
              {"CMD":"1","DV":"0","IO":"0","OV":"100","send":"clear"}
            payload_off: >
              {"CMD":"1","DV":"0","IO":"0","OV":"0","send":"clear"}
            device_class: outlet
        - component: "button"
          name: "query_status"
          config:
            command_topic: "req"
            payload_press: >-
              {"CMD":"3","IO":"30","send":"clear"}
        - component: binary_sensor
          name: "LC"
          config:
            state_topic: "CMD4"
            payload_on: "on"
            payload_off: "off"
            value_template: >-
              {% if value_parsed.LC == 1 %}on{% else %}off{% endif %}
    0x08:
      device_config:
        command: "CMD"
        channel: "CMD"
        log_learn: ""
        direction: ""
        answer: ""
      entities:
        - component: "switch"
          name: "switch"
          config:
            state_topic: "CMD4"
            state_on: "100"
            state_off: "0"
            value_template: "{{ value_parsed.OV }}"
            command_topic: "req"
            payload_on: >
              {"CMD":"1","DV":"0","IO":"0","OV":"100","send":"clear"}
            payload_off: >
              {"CMD":"1","DV":"0","IO":"0","OV":"0","send":"clear"}
            device_class: outlet
        - component: "sensor"
          name: "energy"
          config:
            state_topic: "CMD7"
            state_class: "total_increasing"
            device_class: "energy"
            unit: "Wh"
            value_template: >-
              {% if value_parsed.UN == 0 %}
                {{ (value_parsed.MV|int / 3600)|int }}
              {% elif value_parsed.UN == 1 %}
                {{ value_parsed.MV }}
              {% elif value_parsed.UN == 2 %}
                {{ value_parsed.MV|int * 1000 }}
              {% else %}
                {{ states(entity_id)|int(default=0) }}
              {% endif %}
        - component: "sensor"
          name: "power"
          config:
            state_topic: "CMD7"
            state_class: "measurement"
            device_class: "power"
            unit: "W"
            value_template: >-
              {% if value_parsed.UN == 3 %}
                {{ value_parsed.MV }}
              {% elif value_parsed.UN == 4 %}
                {{ value_parsed.MV|int * 1000 }}
              {% else %}
                {{ states(entity_id)|int(default=0) }}
              {% endif %}
        - component: "button"
          name: "query_energy"
          config:
            command_topic: "req"
            payload_press: >-
              {"CMD":"6","qu":"0","IO":"30","send":"clear"}
        - component: "button"
          name: "query_power"
          config:
            command_topic: "req"
            payload_press: >-
              {"CMD":"6","qu":"1","IO":"30","send":"clear"}
        - component: "button"
          name: "query_status"
          config:
            command_topic: "req"
            payload_press: >-
              {"CMD":"3","IO":"30","send":"clear"}
        - component: "switch"
          name: "reset_meas"
          config:
            command_topic: "__trash"
            icon: "mdi:numeric-0-circle-outline"
        - component: "select"
          name: "meas_type"
          config:
            options:
              - "Query only - Energy in Ws"
              - "Query only - Energy in Wh"
              - "Query only - Energy in KWh"
              - "Query only - Power in W"
              - "Query only - Power in KW"
              - "Query & Auto - Energy in Ws"
              - "Query & Auto - Energy in Wh"
              - "Query & Auto - Energy in KWh"
              - "Query & Auto - Power in W"
              - "Query & Auto - Power in KW"
            command_topic: "__trash"
            icon: "mdi:tune"
        - component: "number"
          name: "meas_MAT"
          config:
            command_topic: "__trash"
            min: "10"
            max: "2550"
            step: "10"
            mode: "box"
            unit: "s"
            icon: "mdi:timer-refresh-outline"
        - component: "number"
          name: "meas_MIT"
          config:
            command_topic: "__trash"
            min: "1"
            max: "255"
            step: "1"
            mode: "box"
            unit: "s"
            icon: "mdi:timer-refresh-outline"
        - component: "number"
          name: "meas_MD"
          config:
            command_topic: "__trash"
            min: "0"
            max: "4095"
            step: "1"
            mode: "box"
            icon: "mdi:equalizer"
        - component: "button"
          name: "set_meas"
          config:
            command_topic: "req"
            command_template: >-
              {% set ns = namespace() %}
              {% for entity in device_entities(device_id(entity_id)) %}
                {% if entity is search('meas_type',ignorecase=True) %}
                  {% if states(entity) is search ('only') %}{% set ns.RM = 0 %}{% else %}{% set ns.RM = 1 %}{% endif %}
                  {% if states(entity) is search ('Energy') %}{% set ns.ep = 0 %}{% else %}{% set ns.ep = 1 %}{% endif %}
                  {% if states(entity) is search ('KWh') %}{% set ns.UN = 2 %}
                  {% elif states(entity) is search (' KW') %}{% set ns.UN = 4 %}
                  {% elif states(entity) is search (' Wh') %}{% set ns.UN = 1 %}
                  {% elif states(entity) is search (' Ws') %}{% set ns.UN = 0 %}
                  {% else %}{% set ns.UN = 3 %}
                  {% endif %}
                {% elif entity is search('reset_meas',ignorecase=True) %}
                  {% if is_state(entity, "on") %}{% set ns.RE = 1 %}{% else %}{% set ns.RE = 0 %}{% endif %}
                {% elif entity is search('meas_mat',ignorecase=True) %}
                  {% set ns.MAT = (states(entity)|int /10)|int(default=10) %}
                {% elif entity is search('meas_mit',ignorecase=True) %}
                  {% set ns.MIT = states(entity)|int(default=1) %}
                {% elif entity is search('meas_md',ignorecase=True) %}
                  {% set ns.MD_MSB = (states(entity)|int/16)|int(default=0) %}
                  {% set ns.MD_LSB = (states(entity)|int%16)|int(default=0) %}
                {% endif %}
              {% endfor %}
              {"CMD":"5","RM":"{{ns.RM}}","RE":"{{ns.RE}}","ep":"{{ns.ep}}","IO":"0","MD_LSB":"{{ns.MD_LSB}}","UN":"{{ns.UN}}","MD_MSB":"{{ns.MD_MSB}}","MAT":"{{ns.MAT}}","MIT":"{{ns.MIT}}", "send":"clear"}
            icon: "mdi:download"
        - component: binary_sensor
          name: "OC"
          config:
            state_topic: "CMD4"
            payload_on: "on"
            payload_off: "off"
            value_template: >-
              {% if value_parsed.OC == 1 %}on{% else %}off{% endif %}
        - component: binary_sensor
          name: "LC"
          config:
            state_topic: "CMD4"
            payload_on: "on"
            payload_off: "off"
            value_template: >-
              {% if value_parsed.LC == 1 %}on{% else %}off{% endif %}
# Template-specific overrides can be added here (e.g., D2/0x12 for lights)
0xF6:
  0x02:
    0x01: &F60201
      device_config:
        command: ""
        channel: ""
        log_learn: ""
        direction: ""
        answer: ""
      entities:
        - component: button
          name: "R1_AI"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R1_AO"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R1_BI"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R1_BO"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R2_AI"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R2_AO"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R2_BI"
          config:
            icon: "mdi:gesture-tap-button"
        - component: button
          name: "R2_BO"
          config:
            icon: "mdi:gesture-tap-button"
        - component: binary_sensor
          name: "EB"
          config:
            payload_on: "1"
            payload_off: "0"
        - component: binary_sensor
          name: "SA"
          config:
            payload_on: "1"
            payload_off: "0"
    0x02: *F60201

0xD5:
  0x00:
    0x01:
      device_config:
        command: ""
        channel: ""
        log_learn: ""
        direction: ""
        answer: ""
      entities:
        - component: binary_sensor
          name: "contact"
          config:
            device_class: "opening"
            payload_on: "0"
            payload_off: "1"

# Example: A5-04-01 Temperature and Humidity Sensor
# This profile includes temperature, humidity, and learn button fields
# Demonstrates value_template usage for different data types
0xA5:
  0x04:
    0x01:
      device_config:
        command: ""
        channel: ""
        log_learn: ""
        direction: ""
        answer: ""
      entities:
        - component: sensor
          name: "TMP"
          config:
            device_class: "temperature"
            unit: "°C"
            state_class: "measurement"
            # Example: Round temperature to 1 decimal place
            value_template: "{{ value | round(1) }}"
        - component: sensor
          name: "HUM"
          config:
            device_class: "humidity"
            unit: "%"
            state_class: "measurement"
            value_template: "{{ value | round(1) }}"
        - component: binary_sensor
          name: "LRN"
          config:
            # Learn button state (1=pressed, 0=not pressed)
            device_class: "power"

0xD1079:
  0x01:
    0x00:
      entities:
        - component: select
          name: "TEMPCELEC"
          config:
            command_template: >-
              {"MSC":"1","CMD":"0","TEMPEL":{{value}},"COMMAND":"1","send":"clear"}
        - component: number
          name: "TEMPMSOUFFL"
          config:
            mode: "box"
            unit: "°C"
            command_template: >-
              {"MSC":"1","CMD":"0","TEMPSOUF":{{value}},"COMMAND":"1","send":"clear"}
        - component: select
          name: "TEMPCHYDROR"
          config:
            command_template: >-
              {"MSC":"1","CMD":"0","TEMPHYD":{{value}},"COMMAND":"1","send":"clear"}
        - component: select
          name: "TEMPSOL"
          config:
            command_template: >-
              {"MSC":"1","CMD":"0","TEMPSOL":{{value}},"COMMAND":"1","send":"clear"}
        - component: switch
          name: "SURV"
          config:
            entity_category: "config"
        - component: switch
          name: "DEBF"
          config:
            entity_category: "config"
        - name: "BOOS"
          config:
            command_template: >-
              {"MSC":"1","command":"0","BOOST":{{value}}, "COMMAND":"1","send":"clear"}
        - name: "VAC"
          config:
            command_template: >-
              {"MSC":"1","CMD":"0","VACS":{{value}}, "COMMAND":"1","send":"clear"}
        - component: sensor
          name: "ETATS"
        - component: sensor
          name: "SAIS"
        - component: sensor
          name: "BYP"
        - component: sensor
          name: "LOC"
        - component: sensor
          name: "PROFAPP"
        - component: sensor
          name: "CVTIM"
          config:
            entity_category: "diagnostic"
        - name: "POS0"
          config:
            entity_category: "config"
        - name: "POS1"
          config:
            entity_category: "config"
        - name: "POS2"
          config:
            entity_category: "config"
        - name: "POS3"
          config:
            entity_category: "config"
        - name: "POS4"
          config:
            entity_category: "config"
        - name: "POSBY1"
          config:
            entity_category: "config"
        - name: "POSBY2"
          config:
            entity_category: "config"
        - name: "POSBY3"
          config:
            entity_category: "config"
        - component: sensor
          name: "OUVBY1"
        - component: sensor
          name: "OUVBY2"
        - component: sensor
          name: "OUVBY3"
        - component: sensor
          name: "TYPCAI"
          config:
            entity_category: "diagnostic"
        - name: "VVENT"
          config:
            entity_category: "config"
        - component: sensor
          name: "JINST"
          config:
            entity_category: "diagnostic"
        - component: sensor
          name: "MINST"
          config:
            entity_category: "diagnostic"
        - component: sensor
          name: "AINST"
          config:
            entity_category: "diagnostic"
        - component: select
          name: "MF"
          config:
            command_template: >-
              {"MSC":"1","CMD":"0","MODEFONC":"{{value}}", "send":"clear"}
        - component: sensor
          name: "CVITM"
        - component: sensor
          name: "PIECEAPP"
        - component: sensor
          name: "CPDIFF"
        - component: sensor
          name: "LAST_DATA_RECEIVED"
          config:
            device_class: "timestamp"
            entity_category: "diagnostic"
            icon: "mdi:clock-outline"
        - component: button
          name: "REFRESH_DATA"
          config:
            command_template: >-
              {"MSC":"1","CMD":"0","COMMAND":"1"}
            entity_category: "diagnostic"
            icon: "mdi:refresh"
